import { exec } from 'child_process';
import { resolve as resolvePath, dirname } from 'path';
import { readlinkSync } from 'fs';
/**
 * Find Java in Linux using three methods:
 * - `update-java-alternatives`,
 * - the JAVA_HOME environment variable
 * - Java on the PATH.
 */
export default function linuxFindJavaHome(cb) {
    const discoveredJavaHomes = [];
    // Option 1: Try the 'update-java-alternatives' tool
    exec('update-java-alternatives -l', (err, stdout, stderr) => {
        // This returns error code 1 on success, for some reason.
        if (!err || err.code == 1) {
            const alts = stdout.toString().trim().split('\n');
            for (const alt of alts) {
                // "java-1.7.0-openjdk-amd64 1071 /usr/lib/jvm/java-1.7.0-openjdk-amd64"
                discoveredJavaHomes.push(alt.split(' ')[2]);
            }
        }
        // Option 2: Is JAVA_HOME defined?
        // (NOTE: locate_java_home will prune redundancies.)
        if (process.env.JAVA_HOME) {
            discoveredJavaHomes.push(process.env.JAVA_HOME);
        }
        // Option 3: Can we invoke binary directly?
        function findByBinary(binaryName, newCb) {
            exec(`${binaryName} -version`, function (err, stdout, stderr) {
                if (err) {
                    // Nope. Return what we have.
                    cb(discoveredJavaHomes);
                }
                else {
                    // Find JAVA_HOME for Java.
                    exec(`which ${binaryName}`, function (err, stdout, stderr) {
                        if (!err) {
                            let javaPath = stdout.toString().trim();
                            // Trace path through symlinks
                            try {
                                while (1) {
                                    // Some symlinks are relative. .resolve is a NOP for absolute paths.
                                    javaPath = resolvePath(dirname(javaPath), readlinkSync(javaPath));
                                }
                            }
                            catch (e) {
                                // We reached the end of the link chain.
                            }
                            // JAVA_HOME/bin/java => JAVA_HOME
                            discoveredJavaHomes.push(resolvePath(javaPath, "..", ".."));
                        }
                        newCb();
                    });
                }
            });
        }
        // Find JRE location
        findByBinary('java', function () {
            // Find JDK location, can be different
            findByBinary('javac', function () {
                cb(discoveredJavaHomes);
            });
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGludXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90cy9saWIvcGxhdGZvcm1zL2xpbnV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDbkMsT0FBTyxFQUFDLE9BQU8sSUFBSSxXQUFXLEVBQUUsT0FBTyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxJQUFJLENBQUM7QUFFaEM7Ozs7O0dBS0c7QUFDSCxNQUFNLENBQUMsT0FBTyxVQUFVLGlCQUFpQixDQUFDLEVBQTJEO0lBQ25HLE1BQU0sbUJBQW1CLEdBQWEsRUFBRSxDQUFDO0lBQ3pDLG9EQUFvRDtJQUNwRCxJQUFJLENBQUMsNkJBQTZCLEVBQUUsQ0FBQyxHQUFpQixFQUFFLE1BQXVCLEVBQUUsTUFBdUIsRUFBRSxFQUFFO1FBQzFHLHlEQUF5RDtRQUN6RCxJQUFJLENBQUMsR0FBRyxJQUFVLEdBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxFQUFFO1lBQ2hDLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDbEQsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLEVBQUU7Z0JBQ3RCLHdFQUF3RTtnQkFDeEUsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUM3QztTQUNGO1FBQ0Qsa0NBQWtDO1FBQ2xDLG9EQUFvRDtRQUNwRCxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQ3pCLG1CQUFtQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVUsQ0FBQyxDQUFDO1NBQ2xEO1FBRUQsMkNBQTJDO1FBQzNDLFNBQVMsWUFBWSxDQUFDLFVBQWtCLEVBQUUsS0FBZ0I7WUFDeEQsSUFBSSxDQUFDLEdBQUcsVUFBVSxXQUFXLEVBQUUsVUFBVSxHQUFpQixFQUFFLE1BQXVCLEVBQUUsTUFBdUI7Z0JBQzFHLElBQUksR0FBRyxFQUFFO29CQUNQLDZCQUE2QjtvQkFDN0IsRUFBRSxDQUFDLG1CQUFtQixDQUFDLENBQUM7aUJBQ3pCO3FCQUFNO29CQUNMLDJCQUEyQjtvQkFDM0IsSUFBSSxDQUFDLFNBQVMsVUFBVSxFQUFFLEVBQUUsVUFBVSxHQUFpQixFQUFFLE1BQXVCLEVBQUUsTUFBdUI7d0JBQ3ZHLElBQUksQ0FBQyxHQUFHLEVBQUU7NEJBQ1IsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDOzRCQUN4Qyw4QkFBOEI7NEJBQzlCLElBQUk7Z0NBQ0YsT0FBTyxDQUFDLEVBQUU7b0NBQ1Isb0VBQW9FO29DQUNwRSxRQUFRLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztpQ0FDbkU7NkJBQ0Y7NEJBQUMsT0FBTyxDQUFDLEVBQUU7Z0NBQ1Ysd0NBQXdDOzZCQUN6Qzs0QkFDRCxrQ0FBa0M7NEJBQ2xDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO3lCQUM3RDt3QkFDRCxLQUFLLEVBQUUsQ0FBQztvQkFDVixDQUFDLENBQUMsQ0FBQztpQkFDSjtZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUNELG9CQUFvQjtRQUNwQixZQUFZLENBQUMsTUFBTSxFQUFFO1lBQ25CLHNDQUFzQztZQUN0QyxZQUFZLENBQUMsT0FBTyxFQUFFO2dCQUNwQixFQUFFLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUMxQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtleGVjfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7cmVzb2x2ZSBhcyByZXNvbHZlUGF0aCwgZGlybmFtZX0gZnJvbSAncGF0aCc7XG5pbXBvcnQge3JlYWRsaW5rU3luY30gZnJvbSAnZnMnO1xuXG4vKipcbiAqIEZpbmQgSmF2YSBpbiBMaW51eCB1c2luZyB0aHJlZSBtZXRob2RzOlxuICogLSBgdXBkYXRlLWphdmEtYWx0ZXJuYXRpdmVzYCxcbiAqIC0gdGhlIEpBVkFfSE9NRSBlbnZpcm9ubWVudCB2YXJpYWJsZVxuICogLSBKYXZhIG9uIHRoZSBQQVRILlxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBsaW51eEZpbmRKYXZhSG9tZShjYjogKGhvbWVzOiBzdHJpbmdbXSwgZXhlY3V0YWJsZUV4dGVuc2lvbj86IHN0cmluZykgPT4gdm9pZCk6IHZvaWQge1xuICBjb25zdCBkaXNjb3ZlcmVkSmF2YUhvbWVzOiBzdHJpbmdbXSA9IFtdO1xuICAvLyBPcHRpb24gMTogVHJ5IHRoZSAndXBkYXRlLWphdmEtYWx0ZXJuYXRpdmVzJyB0b29sXG4gIGV4ZWMoJ3VwZGF0ZS1qYXZhLWFsdGVybmF0aXZlcyAtbCcsIChlcnI6IEVycm9yIHwgbnVsbCwgc3Rkb3V0OiBCdWZmZXIgfCBzdHJpbmcsIHN0ZGVycjogQnVmZmVyIHwgc3RyaW5nKSA9PiB7XG4gICAgLy8gVGhpcyByZXR1cm5zIGVycm9yIGNvZGUgMSBvbiBzdWNjZXNzLCBmb3Igc29tZSByZWFzb24uXG4gICAgaWYgKCFlcnIgfHwgKDxhbnk+ZXJyKS5jb2RlID09IDEpIHtcbiAgICAgIGNvbnN0IGFsdHMgPSBzdGRvdXQudG9TdHJpbmcoKS50cmltKCkuc3BsaXQoJ1xcbicpO1xuICAgICAgZm9yIChjb25zdCBhbHQgb2YgYWx0cykge1xuICAgICAgICAvLyBcImphdmEtMS43LjAtb3Blbmpkay1hbWQ2NCAxMDcxIC91c3IvbGliL2p2bS9qYXZhLTEuNy4wLW9wZW5qZGstYW1kNjRcIlxuICAgICAgICBkaXNjb3ZlcmVkSmF2YUhvbWVzLnB1c2goYWx0LnNwbGl0KCcgJylbMl0pO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBPcHRpb24gMjogSXMgSkFWQV9IT01FIGRlZmluZWQ/XG4gICAgLy8gKE5PVEU6IGxvY2F0ZV9qYXZhX2hvbWUgd2lsbCBwcnVuZSByZWR1bmRhbmNpZXMuKVxuICAgIGlmIChwcm9jZXNzLmVudi5KQVZBX0hPTUUpIHtcbiAgICAgIGRpc2NvdmVyZWRKYXZhSG9tZXMucHVzaChwcm9jZXNzLmVudi5KQVZBX0hPTUUhKTtcbiAgICB9XG5cbiAgICAvLyBPcHRpb24gMzogQ2FuIHdlIGludm9rZSBiaW5hcnkgZGlyZWN0bHk/XG4gICAgZnVuY3Rpb24gZmluZEJ5QmluYXJ5KGJpbmFyeU5hbWU6IHN0cmluZywgbmV3Q2I6ICgpID0+IGFueSkge1xuICAgICAgZXhlYyhgJHtiaW5hcnlOYW1lfSAtdmVyc2lvbmAsIGZ1bmN0aW9uIChlcnI6IEVycm9yIHwgbnVsbCwgc3Rkb3V0OiBCdWZmZXIgfCBzdHJpbmcsIHN0ZGVycjogQnVmZmVyIHwgc3RyaW5nKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAvLyBOb3BlLiBSZXR1cm4gd2hhdCB3ZSBoYXZlLlxuICAgICAgICAgIGNiKGRpc2NvdmVyZWRKYXZhSG9tZXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIEZpbmQgSkFWQV9IT01FIGZvciBKYXZhLlxuICAgICAgICAgIGV4ZWMoYHdoaWNoICR7YmluYXJ5TmFtZX1gLCBmdW5jdGlvbiAoZXJyOiBFcnJvciB8IG51bGwsIHN0ZG91dDogQnVmZmVyIHwgc3RyaW5nLCBzdGRlcnI6IEJ1ZmZlciB8IHN0cmluZykge1xuICAgICAgICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgICAgICAgbGV0IGphdmFQYXRoID0gc3Rkb3V0LnRvU3RyaW5nKCkudHJpbSgpO1xuICAgICAgICAgICAgICAvLyBUcmFjZSBwYXRoIHRocm91Z2ggc3ltbGlua3NcbiAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB3aGlsZSAoMSkge1xuICAgICAgICAgICAgICAgICAgLy8gU29tZSBzeW1saW5rcyBhcmUgcmVsYXRpdmUuIC5yZXNvbHZlIGlzIGEgTk9QIGZvciBhYnNvbHV0ZSBwYXRocy5cbiAgICAgICAgICAgICAgICAgIGphdmFQYXRoID0gcmVzb2x2ZVBhdGgoZGlybmFtZShqYXZhUGF0aCksIHJlYWRsaW5rU3luYyhqYXZhUGF0aCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIC8vIFdlIHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgbGluayBjaGFpbi5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAvLyBKQVZBX0hPTUUvYmluL2phdmEgPT4gSkFWQV9IT01FXG4gICAgICAgICAgICAgIGRpc2NvdmVyZWRKYXZhSG9tZXMucHVzaChyZXNvbHZlUGF0aChqYXZhUGF0aCwgXCIuLlwiLCBcIi4uXCIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ld0NiKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBGaW5kIEpSRSBsb2NhdGlvblxuICAgIGZpbmRCeUJpbmFyeSgnamF2YScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vIEZpbmQgSkRLIGxvY2F0aW9uLCBjYW4gYmUgZGlmZmVyZW50XG4gICAgICBmaW5kQnlCaW5hcnkoJ2phdmFjJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBjYihkaXNjb3ZlcmVkSmF2YUhvbWVzKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn1cbiJdfQ==