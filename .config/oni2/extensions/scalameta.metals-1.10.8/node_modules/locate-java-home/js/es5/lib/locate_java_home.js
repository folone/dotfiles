"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
const path_1 = require("path");
const child_process_1 = require("child_process");
const semver_1 = require("semver");
const async_1 = require("async");
const platform_1 = require("./platform");
const defaultOptions = {
    version: "*",
    mustBeJDK: false,
    mustBeJRE: false,
    paranoid: false,
    mustBe64Bit: false
};
/**
 * Return an ILocateJavaHomeOptions object with defaults filled in.
 */
function fillInDefaults(opts) {
    // semver standardization
    if (opts.version === 'any') {
        opts.version = "*";
    }
    return Object.assign({}, defaultOptions, opts);
}
function locateJavaHome(arg1, arg2) {
    let options = defaultOptions;
    let cb = arg1;
    if (arg2) {
        cb = arg2;
        options = fillInDefaults(arg1);
    }
    // Sanity check
    if (options.mustBeJDK && options.mustBeJRE) {
        return cb(new Error(`Unsatisfiable options: A JAVA_HOME cannot be both a JDK and not a JDK.`), []);
    }
    let locateJavaHome = platform_1.default(process.platform);
    locateJavaHome((homes, executableExtension) => {
        const homeInfos = [];
        // NOTE: We don't use async.map here because we want to be error tolerant
        // in case some of the JAVA_HOME locations are erroneous.
        async_1.each(homes, (home, asyncCb) => {
            getJavaHomeInfo(home, executableExtension, (err, homeInfo) => {
                if (!err) {
                    // Push the info and continue iteration.
                    homeInfos.push(homeInfo);
                    asyncCb();
                }
                else if (options.paranoid) {
                    // Report the error, halting iteration.
                    asyncCb(err);
                }
                else {
                    // Ignore JAVA_HOME.
                    asyncCb();
                }
            });
        }, (err) => {
            var seenPaths = {};
            if (err) {
                cb(err);
            }
            else {
                cb(null, homeInfos
                    .filter((homeInfo) => {
                    // Absolute pathify.
                    homeInfo.path = path_1.resolve(homeInfo.path);
                    // Filter redundant paths.
                    if (seenPaths[homeInfo.path]) {
                        return false;
                    }
                    else {
                        seenPaths[homeInfo.path] = true;
                    }
                    // JDK constraint
                    return (!options.mustBeJDK || homeInfo.isJDK)
                        // JRE constraint
                        && (!options.mustBeJRE || !homeInfo.isJDK)
                        // 64-bit constraint
                        && (!options.mustBe64Bit || homeInfo.is64Bit)
                        // version constraint
                        && semver_1.satisfies(homeInfo.version, options.version);
                }).sort((a, b) => a.path.localeCompare(b.path)));
            }
        });
    });
}
/**
 * Get the IJavaHomeInfo object for the given path.
 */
function getJavaHomeInfo(home, executableExtension, cb) {
    const javaPath = getBinaryPath(home, 'java', executableExtension);
    const javacPath = getBinaryPath(home, 'javac', executableExtension);
    if (!javaPath) {
        return cb(new Error(`Unable to locate 'java' executable in path ${home}`));
    }
    getJavaVersionAndDataModel(javaPath, (err, version, security, is64Bit) => {
        if (err) {
            cb(err);
        }
        else {
            let info = {
                path: home,
                version: version,
                security: security,
                isJDK: javacPath !== null,
                is64Bit: is64Bit,
                executables: {
                    java: javaPath
                }
            };
            if (javacPath) {
                info.executables.javac = javacPath;
                info.executables.javap = getBinaryPath(home, 'javap', executableExtension);
            }
            cb(null, info);
        }
    });
}
/**
 * Get the path to a binary in JAVA_HOME. Returns NULL if it does not exist.
 */
function getBinaryPath(home, name, executableExtension) {
    const binPath = path_1.resolve(home, 'bin', `${name}${executableExtension ? `.${executableExtension}` : ''}`);
    if (fs_1.existsSync(binPath)) {
        return binPath;
    }
    return null;
}
/**
 * Given a path to the java executable, get the version of JAVA_HOME.
 */
function getJavaVersionAndDataModel(javaPath, cb) {
    child_process_1.exec(`"${javaPath}" -version`, function (err, stdout, stderr) {
        if (err) {
            return cb(err);
        }
        // TODO: Make this more robust to errors.
        const output = stderr.toString();
        const versionData = /(\d+\.\d+\.\d+)(_(\d+))?/.exec(output);
        let version = "0.0.0";
        let security = 0;
        if (versionData !== null) {
            version = versionData[1];
            security = parseInt(versionData[3], 10);
            if (isNaN(security)) {
                security = 0;
            }
        }
        return cb(err, version, security, output.toLowerCase().indexOf("64-bit") !== -1);
    });
}
exports.default = locateJavaHome;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYXRlX2phdmFfaG9tZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3RzL2xpYi9sb2NhdGVfamF2YV9ob21lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkJBQThCO0FBQzlCLCtCQUE0QztBQUM1QyxpREFBbUM7QUFDbkMsbUNBQW9EO0FBQ3BELGlDQUF3QztBQUV4Qyx5Q0FBa0M7QUFFbEMsTUFBTSxjQUFjLEdBQUc7SUFDckIsT0FBTyxFQUFFLEdBQUc7SUFDWixTQUFTLEVBQUUsS0FBSztJQUNoQixTQUFTLEVBQUUsS0FBSztJQUNoQixRQUFRLEVBQUUsS0FBSztJQUNmLFdBQVcsRUFBRSxLQUFLO0NBQ25CLENBQUM7QUFJRjs7R0FFRztBQUNILFNBQVMsY0FBYyxDQUFDLElBQTRCO0lBQ2xELHlCQUF5QjtJQUN6QixJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssS0FBSyxFQUFFO1FBQzFCLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO0tBQ3BCO0lBQ0QsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDakQsQ0FBQztBQVNELFNBQVMsY0FBYyxDQUFDLElBQVMsRUFBRSxJQUEyRDtJQUM1RixJQUFJLE9BQU8sR0FBd0IsY0FBYyxDQUFDO0lBQ2xELElBQUksRUFBRSxHQUF5RCxJQUFJLENBQUM7SUFDcEUsSUFBSSxJQUFJLEVBQUU7UUFDUixFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ1YsT0FBTyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNoQztJQUVELGVBQWU7SUFDZixJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRTtRQUMxQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQyx3RUFBd0UsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ3BHO0lBRUQsSUFBSSxjQUFjLEdBQW9C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QXVCLEVBQUUsTUFBdUI7UUFDMUcsSUFBSSxHQUFHLEVBQUU7WUFDUCxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNoQjtRQUNELHlDQUF5QztRQUN6QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakMsTUFBTSxXQUFXLEdBQUcsMEJBQTBCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVELElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN0QixJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDakIsSUFBSSxXQUFXLEtBQUssSUFBSSxFQUFFO1lBQ3hCLE9BQU8sR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekIsUUFBUSxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDeEMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQ25CLFFBQVEsR0FBRyxDQUFDLENBQUM7YUFDZDtTQUNGO1FBQ0QsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25GLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELGtCQUFlLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7ZXhpc3RzU3luY30gZnJvbSAnZnMnO1xuaW1wb3J0IHtyZXNvbHZlIGFzIHJlc29sdmVQYXRofSBmcm9tICdwYXRoJztcbmltcG9ydCB7ZXhlY30gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQge3NhdGlzZmllcyBhcyBzZW12ZXJTYXRpc2ZpZXN9IGZyb20gJ3NlbXZlcic7XG5pbXBvcnQge2VhY2ggYXMgYXN5bmNFYWNofSBmcm9tICdhc3luYyc7XG5pbXBvcnQge0lMb2NhdGVKYXZhSG9tZU9wdGlvbnMsIElKYXZhSG9tZUluZm8sIElMb2NhdGVKYXZhSG9tZX0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCBQbGF0Zm9ybSBmcm9tICcuL3BsYXRmb3JtJztcblxuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gIHZlcnNpb246IFwiKlwiLFxuICBtdXN0QmVKREs6IGZhbHNlLFxuICBtdXN0QmVKUkU6IGZhbHNlLFxuICBwYXJhbm9pZDogZmFsc2UsXG4gIG11c3RCZTY0Qml0OiBmYWxzZVxufTtcblxudHlwZSBTdGFuZGFyZGl6ZWRPcHRpb25zID0gSUxvY2F0ZUphdmFIb21lT3B0aW9ucyAmIHR5cGVvZiBkZWZhdWx0T3B0aW9ucztcblxuLyoqXG4gKiBSZXR1cm4gYW4gSUxvY2F0ZUphdmFIb21lT3B0aW9ucyBvYmplY3Qgd2l0aCBkZWZhdWx0cyBmaWxsZWQgaW4uXG4gKi9cbmZ1bmN0aW9uIGZpbGxJbkRlZmF1bHRzKG9wdHM6IElMb2NhdGVKYXZhSG9tZU9wdGlvbnMpOiBTdGFuZGFyZGl6ZWRPcHRpb25zIHtcbiAgLy8gc2VtdmVyIHN0YW5kYXJkaXphdGlvblxuICBpZiAob3B0cy52ZXJzaW9uID09PSAnYW55Jykge1xuICAgIG9wdHMudmVyc2lvbiA9IFwiKlwiO1xuICB9XG4gIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0T3B0aW9ucywgb3B0cyk7XG59XG5cbi8qKlxuICogTG9jYXRlcyBqYXZhIGhvbWUuXG4gKlxuICogQ2FsbHMgdGhlIGNhbGxiYWNrIHdpdGggYSBtYXRjaGluZyBKQVZBX0hPTUUuXG4gKi9cbmZ1bmN0aW9uIGxvY2F0ZUphdmFIb21lKGNiOiAoZXJyOiBFcnJvciB8IG51bGwsIGZvdW5kPzogSUphdmFIb21lSW5mb1tdKSA9PiB2b2lkKTogdm9pZDtcbmZ1bmN0aW9uIGxvY2F0ZUphdmFIb21lKG9wdGlvbnM6IElMb2NhdGVKYXZhSG9tZU9wdGlvbnMsIGNiOiAoZXJyOiBFcnJvciB8IG51bGwsIGZvdW5kPzogSUphdmFIb21lSW5mb1tdKSA9PiB2b2lkKTogdm9pZDtcbmZ1bmN0aW9uIGxvY2F0ZUphdmFIb21lKGFyZzE6IGFueSwgYXJnMj86IChlcnI6IEVycm9yIHwgbnVsbCwgZm91bmQ/OiBJSmF2YUhvbWVJbmZvW10pID0+IHZvaWQpOiB2b2lkIHtcbiAgbGV0IG9wdGlvbnM6IFN0YW5kYXJkaXplZE9wdGlvbnMgPSBkZWZhdWx0T3B0aW9ucztcbiAgbGV0IGNiOiAoZXJyOiBFcnJvciB8IG51bGwsIGZvdW5kPzogSUphdmFIb21lSW5mb1tdKSA9PiB2b2lkID0gYXJnMTtcbiAgaWYgKGFyZzIpIHtcbiAgICBjYiA9IGFyZzI7XG4gICAgb3B0aW9ucyA9IGZpbGxJbkRlZmF1bHRzKGFyZzEpO1xuICB9XG5cbiAgLy8gU2FuaXR5IGNoZWNrXG4gIGlmIChvcHRpb25zLm11c3RCZUpESyAmJiBvcHRpb25zLm11c3RCZUpSRSkge1xuICAgIHJldHVybiBjYihuZXcgRXJyb3IoYFVuc2F0aXNmaWFibGUgb3B0aW9uczogQSBKQVZBX0hPTUUgY2Fubm90IGJlIGJvdGggYSBKREsgYW5kIG5vdCBhIEpESy5gKSwgW10pO1xuICB9XG5cbiAgbGV0IGxvY2F0ZUphdmFIb21lOiBJTG9jYXRlSmF2YUhvbWUgPSBQbGF0Zm9ybShwcm9jZXNzLnBsYXRmb3JtKTtcblxuICBsb2NhdGVKYXZhSG9tZSgoaG9tZXM6IHN0cmluZ1tdLCBleGVjdXRhYmxlRXh0ZW5zaW9uPzogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgaG9tZUluZm9zOiBJSmF2YUhvbWVJbmZvW10gPSBbXTtcbiAgICAvLyBOT1RFOiBXZSBkb24ndCB1c2UgYXN5bmMubWFwIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIGJlIGVycm9yIHRvbGVyYW50XG4gICAgLy8gaW4gY2FzZSBzb21lIG9mIHRoZSBKQVZBX0hPTUUgbG9jYXRpb25zIGFyZSBlcnJvbmVvdXMuXG4gICAgYXN5bmNFYWNoKGhvbWVzLCAoaG9tZTogc3RyaW5nLCBhc3luY0NiOiAoZXJyPzogRXJyb3IpID0+IHZvaWQpID0+IHtcbiAgICAgIGdldEphdmFIb21lSW5mbyhob21lLCBleGVjdXRhYmxlRXh0ZW5zaW9uLCAoZXJyOiBFcnJvciB8IG51bGwsIGhvbWVJbmZvPzogSUphdmFIb21lSW5mbykgPT4ge1xuICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgIC8vIFB1c2ggdGhlIGluZm8gYW5kIGNvbnRpbnVlIGl0ZXJhdGlvbi5cbiAgICAgICAgICBob21lSW5mb3MucHVzaChob21lSW5mbyEpO1xuICAgICAgICAgIGFzeW5jQ2IoKTtcbiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnBhcmFub2lkKSB7XG4gICAgICAgICAgLy8gUmVwb3J0IHRoZSBlcnJvciwgaGFsdGluZyBpdGVyYXRpb24uXG4gICAgICAgICAgYXN5bmNDYihlcnIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIElnbm9yZSBKQVZBX0hPTUUuXG4gICAgICAgICAgYXN5bmNDYigpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9LCAoZXJyPzogRXJyb3IpID0+IHtcbiAgICAgIHZhciBzZWVuUGF0aHM6IHtbcGF0aDogc3RyaW5nXTogYm9vbGVhbn0gPSB7fTtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgY2IoZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNiKG51bGwsIGhvbWVJbmZvc1xuICAgICAgICAgIC5maWx0ZXIoKGhvbWVJbmZvKSA9PiB7XG4gICAgICAgICAgICAvLyBBYnNvbHV0ZSBwYXRoaWZ5LlxuICAgICAgICAgICAgaG9tZUluZm8ucGF0aCA9IHJlc29sdmVQYXRoKGhvbWVJbmZvLnBhdGgpO1xuICAgICAgICAgICAgLy8gRmlsdGVyIHJlZHVuZGFudCBwYXRocy5cbiAgICAgICAgICAgIGlmIChzZWVuUGF0aHNbaG9tZUluZm8ucGF0aF0pIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgc2VlblBhdGhzW2hvbWVJbmZvLnBhdGhdID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gSkRLIGNvbnN0cmFpbnRcbiAgICAgICAgICAgIHJldHVybiAoIW9wdGlvbnMubXVzdEJlSkRLIHx8IGhvbWVJbmZvLmlzSkRLKVxuICAgICAgICAgICAgICAvLyBKUkUgY29uc3RyYWludFxuICAgICAgICAgICAgICAmJiAoIW9wdGlvbnMubXVzdEJlSlJFIHx8ICFob21lSW5mby5pc0pESylcbiAgICAgICAgICAgICAgLy8gNjQtYml0IGNvbnN0cmFpbnRcbiAgICAgICAgICAgICAgJiYgKCFvcHRpb25zLm11c3RCZTY0Qml0IHx8IGhvbWVJbmZvLmlzNjRCaXQpXG4gICAgICAgICAgICAgIC8vIHZlcnNpb24gY29uc3RyYWludFxuICAgICAgICAgICAgICAmJiBzZW12ZXJTYXRpc2ZpZXMoaG9tZUluZm8udmVyc2lvbiwgb3B0aW9ucy52ZXJzaW9uKTtcbiAgICAgICAgICB9KS5zb3J0KChhLCBiKSA9PiBhLnBhdGgubG9jYWxlQ29tcGFyZShiLnBhdGgpKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIElKYXZhSG9tZUluZm8gb2JqZWN0IGZvciB0aGUgZ2l2ZW4gcGF0aC5cbiAqL1xuZnVuY3Rpb24gZ2V0SmF2YUhvbWVJbmZvKGhvbWU6IHN0cmluZywgZXhlY3V0YWJsZUV4dGVuc2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkLCBjYjogKGVycjogRXJyb3IgfCBudWxsLCBpbmZvPzogSUphdmFIb21lSW5mbykgPT4gdm9pZCk6IHZvaWQge1xuICBjb25zdCBqYXZhUGF0aCA9IGdldEJpbmFyeVBhdGgoaG9tZSwgJ2phdmEnLCBleGVjdXRhYmxlRXh0ZW5zaW9uKTtcbiAgY29uc3QgamF2YWNQYXRoID0gZ2V0QmluYXJ5UGF0aChob21lLCAnamF2YWMnLCBleGVjdXRhYmxlRXh0ZW5zaW9uKTtcbiAgaWYgKCFqYXZhUGF0aCkge1xuICAgIHJldHVybiBjYihuZXcgRXJyb3IoYFVuYWJsZSB0byBsb2NhdGUgJ2phdmEnIGV4ZWN1dGFibGUgaW4gcGF0aCAke2hvbWV9YCkpO1xuICB9XG4gIGdldEphdmFWZXJzaW9uQW5kRGF0YU1vZGVsKGphdmFQYXRoLCAoZXJyOiBFcnJvciB8IG51bGwsIHZlcnNpb24/OiBzdHJpbmcsIHNlY3VyaXR5PzogbnVtYmVyLCBpczY0Qml0PzogYm9vbGVhbikgPT4ge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGNiKGVycik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBpbmZvOiBJSmF2YUhvbWVJbmZvID0ge1xuICAgICAgICBwYXRoOiBob21lLFxuICAgICAgICB2ZXJzaW9uOiB2ZXJzaW9uISxcbiAgICAgICAgc2VjdXJpdHk6IHNlY3VyaXR5ISxcbiAgICAgICAgaXNKREs6IGphdmFjUGF0aCAhPT0gbnVsbCxcbiAgICAgICAgaXM2NEJpdDogaXM2NEJpdCEsXG4gICAgICAgIGV4ZWN1dGFibGVzOiB7XG4gICAgICAgICAgamF2YTogamF2YVBhdGhcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgaWYgKGphdmFjUGF0aCkge1xuICAgICAgICBpbmZvLmV4ZWN1dGFibGVzLmphdmFjID0gamF2YWNQYXRoO1xuICAgICAgICBpbmZvLmV4ZWN1dGFibGVzLmphdmFwID0gZ2V0QmluYXJ5UGF0aChob21lLCAnamF2YXAnLCBleGVjdXRhYmxlRXh0ZW5zaW9uKSE7XG4gICAgICB9XG4gICAgICBjYihudWxsLCBpbmZvKTtcbiAgICB9XG4gIH0pO1xufVxuXG4vKipcbiAqIEdldCB0aGUgcGF0aCB0byBhIGJpbmFyeSBpbiBKQVZBX0hPTUUuIFJldHVybnMgTlVMTCBpZiBpdCBkb2VzIG5vdCBleGlzdC5cbiAqL1xuZnVuY3Rpb24gZ2V0QmluYXJ5UGF0aChob21lOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZXhlY3V0YWJsZUV4dGVuc2lvbj86IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICBjb25zdCBiaW5QYXRoID0gcmVzb2x2ZVBhdGgoaG9tZSwgJ2JpbicsIGAke25hbWV9JHtleGVjdXRhYmxlRXh0ZW5zaW9uID8gYC4ke2V4ZWN1dGFibGVFeHRlbnNpb259YCA6ICcnfWApO1xuICBpZiAoZXhpc3RzU3luYyhiaW5QYXRoKSkge1xuICAgIHJldHVybiBiaW5QYXRoO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG4vKipcbiAqIEdpdmVuIGEgcGF0aCB0byB0aGUgamF2YSBleGVjdXRhYmxlLCBnZXQgdGhlIHZlcnNpb24gb2YgSkFWQV9IT01FLlxuICovXG5mdW5jdGlvbiBnZXRKYXZhVmVyc2lvbkFuZERhdGFNb2RlbChqYXZhUGF0aDogc3RyaW5nLCBjYjogKGVycjogRXJyb3IgfCBudWxsLCB2ZXJzaW9uPzogc3RyaW5nLCBzZWN1cml0eT86IG51bWJlciwgaXM2NEJpdD86IGJvb2xlYW4pID0+IHZvaWQpIHtcbiAgZXhlYyhgXCIke2phdmFQYXRofVwiIC12ZXJzaW9uYCwgZnVuY3Rpb24gKGVycjogRXJyb3IgfCBudWxsLCBzdGRvdXQ6IHN0cmluZyB8IEJ1ZmZlciwgc3RkZXJyOiBzdHJpbmcgfCBCdWZmZXIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICB9XG4gICAgLy8gVE9ETzogTWFrZSB0aGlzIG1vcmUgcm9idXN0IHRvIGVycm9ycy5cbiAgICBjb25zdCBvdXRwdXQgPSBzdGRlcnIudG9TdHJpbmcoKTtcbiAgICBjb25zdCB2ZXJzaW9uRGF0YSA9IC8oXFxkK1xcLlxcZCtcXC5cXGQrKShfKFxcZCspKT8vLmV4ZWMob3V0cHV0KTtcbiAgICBsZXQgdmVyc2lvbiA9IFwiMC4wLjBcIjtcbiAgICBsZXQgc2VjdXJpdHkgPSAwO1xuICAgIGlmICh2ZXJzaW9uRGF0YSAhPT0gbnVsbCkge1xuICAgICAgdmVyc2lvbiA9IHZlcnNpb25EYXRhWzFdO1xuICAgICAgc2VjdXJpdHkgPSBwYXJzZUludCh2ZXJzaW9uRGF0YVszXSwgMTApO1xuICAgICAgaWYgKGlzTmFOKHNlY3VyaXR5KSkge1xuICAgICAgICBzZWN1cml0eSA9IDA7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBjYihlcnIsIHZlcnNpb24sIHNlY3VyaXR5LCBvdXRwdXQudG9Mb3dlckNhc2UoKS5pbmRleE9mKFwiNjQtYml0XCIpICE9PSAtMSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBsb2NhdGVKYXZhSG9tZTtcbiJdfQ==