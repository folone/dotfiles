"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.downloadProgress = void 0;
/**
 * Utility to track the progress of a running download
 */
function downloadProgress({ download, onProgress, onComplete, onError, }) {
    var _a, _b;
    let stdout = [];
    let stderr = [];
    (_a = download.stdout) === null || _a === void 0 ? void 0 : _a.on("data", (out) => {
        stdout.push(out);
    });
    (_b = download.stderr) === null || _b === void 0 ? void 0 : _b.on("data", (err) => {
        const msg = err.toString().trim();
        stderr.push(err);
        if (msg.startsWith("Downloaded") || msg.startsWith("Downloading")) {
            onProgress(msg);
        }
    });
    download.on("close", (code) => {
        if (code != 0) {
            onError(stderr);
            throw new Error(`Coursier exit: ${code}`);
        }
    });
    return download.then(() => {
        onComplete && onComplete();
        return stdout.map((buffer) => buffer.toString().trim()).join("");
    });
}
exports.downloadProgress = downloadProgress;
